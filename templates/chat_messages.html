<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chat Room: {{.ChatName}}</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
    <div class="container">
        <h2>Chat Room: {{.ChatName}}</h2>

        <!-- Display Messages -->
        <div class="chat-box">
            <ul id="message-list">
                {{range .Messages}}
                <li>
                    <strong>{{.Sender}}:</strong> {{.Message}}
                    <span style="float: right;">{{.Timestamp}}</span>
                </li>
                {{else}}
                <p>No messages in this chat yet. Be the first to send one!</p>
                {{end}}
            </ul>
        </div>

        <!-- Chat Input -->
        <form id="chatForm" method="POST" action="/send-message">
            <input type="text" id="messageInput" name="message" placeholder="Enter message..." required>
            <button type="submit">Send</button>
        </form>

        <!-- Button to return to chat selection page -->
        <form action="/welcome" method="get">
            <button type="submit" style="margin-top: 10px;">Back to Chats</button>
        </form>

        <script>
            function fetchMessages(chatName) {
                fetch(`/fetch-messages?chatname=${chatName}`)
                    .then(response => response.json())
                    .then(messages => {
                        const messageList = document.getElementById("message-list");
                        messageList.innerHTML = ""; // Clear current messages

                        if (!Array.isArray(messages) || messages.length === 0) {
                            // Handle the case where messages are empty
                            const noMessagesMessage = document.createElement("p");
                            noMessagesMessage.textContent = "No messages in this chat yet. Be the first to send one!";
                            messageList.appendChild(noMessagesMessage);
                            return;
                        }

                        messages.forEach(msg => {
                            const listItem = document.createElement("li");
                            listItem.innerHTML = `<strong>${msg.Sender}:</strong> ${msg.Message} <span style="float: right;">${msg.Timestamp}</span>`;
                            messageList.appendChild(listItem);
                        });
                    })
                    .catch(error => console.error("Error fetching messages:", error));
            }

            // Poll every 4 seconds to update messages
            setInterval(() => {
                fetchMessages("{{.ChatName}}"); // Pass dynamic chat name from template
            }, 4000);

            // Send message form submission
            document.getElementById("chatForm").onsubmit = function (e) {
                e.preventDefault();

                const formData = new FormData(e.target);
                fetch("/send-message", {
                    method: "POST",
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        console.error("Failed to send message:", response.statusText);
                    }
                    fetchMessages("{{.ChatName}}"); // Refresh messages after sending
                }).catch(error => {
                    console.error("Error sending message:", error);
                });

                e.target.reset(); // Clear input
            };

            // Initial load of messages
            fetchMessages("{{.ChatName}}"); // Load messages for the current chat
        </script>

    </div>
</body>

</html>
