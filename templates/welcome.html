<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Forum de voyage - Partagez vos expériences et conseils sur les destinations de la France.">
    <meta name="keywords" content="forum, voyage, destinations, partage, communauté">
    <meta name="author" content="Matias, Sara, Samuel, William">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Pacifico&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sen:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <title>MyTripy</title>
    <link rel="stylesheet" href="static/css/styles.css">
    <link rel="stylesheet" href="static/css/styles-desktop.css" media="screen and (min-width: 1024px)">
</head>

<body>

    <!-- Header -->
    <header>
        <!-- Logo -->
        <a href="/mytripy-non" class="logo">
            <img class="image_logo" src="static/img/logo/logo-mytripy-2.png" alt="MyTripy Logo">
            <img class="mytripy" src="static/img/logo/mytripy.png" alt="MyTripy">
            <!-- <span class="text_logo">My<span>Trip</span>y</span> -->
        </a>

        <!-- Menu Burger -->
        <button class="burger-menu" id="burger">
            <img src="static/img/menu-black.png" alt="menu">
        </button>

    </header>


    <ul class="meta-ul">
        <li class="meta-navigation">
            <a class="meta-a" href="/mytripy-non">MyTripy</a>
        </li>

        <li class="meta-navigation">
            <a class="meta-a" href="/destinations">Destinations</a>
        </li>

        <li class="meta-navigation">
            <a class="meta-a" href="mailto:contact@voyagesympa.com?subject=Demande%20d'informations&body=Bonjour%2C%0AJe%20voudrais%20plus%20d'informations%20sur...">Contactez-nous</a>
        </li>

        {{if .IsConnected}}

        <li class="meta-navigation-btn-connexion">
            <a class="btn" href="/profil">Mon Compte</a>
        </li>

        {{else}}

        <li class="meta-navigation-btn-connexion">
            <a class="btn" href="/SeConnecter">Se connecter</a>
        </li>

        <li class="meta-navigation-btn-creer-compte">
            <a class="btn" href="/CreerCompte">Créer mon compte</a>
        </li>

        {{end}}

    </ul>

    </header>




    <!-- Contenu principal -->
    <section>
        <!-- Barre de recherche  (non so se metterla perché cerca le regioni soltanto non i chat, oppure faccio in modo che cerchi i post quando sono su questa regione)-->
        <div class="search-bar">
            <input type="text" placeholder="Rechercher une destination..." id="searchBar" oninput="filterOptions()">
            <button id="search-icon" class="search-icon"><img src="static/img/loupe.png" alt="Icone recherche"></button>
        </div>
        <div id="dropdown" class="dropdown"></div>


        <div class="discussion-principale">
            <div class="discussion-cree" onclick="selectChat('{{.MainChat.Name}}')">
                <div class="discussion-cree-info">
                    <img src="{{.MainChat.ImageURL}}" alt="" class="discussion-cree-info-profil">

                    <div class="discussion-cree-info-texte">
                        <p class="discussion-cree-info-titre">{{.MainChat.Name}}</p>
                        <p class="discussion-cree-info-nom">MyTripy</p>
                    </div>
                </div>

                <p class="discussion-cree-descriptif">{{.MainChat.Descri}}</p>

                <div class="discussion-cree-chat">
                        {{if $.IsConnected}}
                        <div class="chat-coeur-container" data-chat="{{.MainChat.Name}}">
                            {{if .MainChat.UserLiked}}
                                <img src="static/img/coeur_rouge.png" alt="Liked" class="chat-coeur">
                            {{else}}
                                <img src="static/img/coeurGris.png" alt="Like" class="chat-coeur">
                            {{end}}
                            <p>{{.MainChat.TotalLikes}}</p>
                        </div>
                        {{end}}
                    <div class="discussionFil">
                        <img src="static/img/messager.png" alt="discussion">
                        <p>{{.MainChat.MessageCount}}</p>
                    </div>
                </div>
            </div>
        </div>

        {{if .IsConnected}}
        <div class="ajouterBtn">
            <img src="../static/img/ajouter.png" class="btnAjouterFil" id="btnAjouterFil" onclick="PopupFils()">
        </div>
        {{end}}

        <div class="popupAjouterFil" id="popupAjouterFil">
            <img src="/static/img/fondPopupFil.png">
            <h3>Nouveau Fil</h3>
            <input id="chatTitle" placeholder="Entrez le Titre de votre nouveau Fil" class="nomFil" required>
            <input id="chatDescription" placeholder="Entrez la Description de votre nouveau Fil" class="descriptionFil"
                required>
            <div class="paramFil">
                <h4>{{.Region}}</h4>
                <input id="regionField" type="hidden" value="{{.Region}}">
            </div>
            <button onclick="createChat()">Créer</button>
        </div>

        <!--       
         <div class="popupAjouterFil" id="popupAjouterFil">
            <img src="/static/img/fondPopupFil.png">
            <h3>Nouveau Fils</h3>
            <input id="chatTitle" placeholder="Entrez le Titre de votre nouveau Fil" class="nomFil"> 
            <input id="chatDescription" placeholder="Entrez la Description de votre nouveau Fil" class="descriptionFil"> 
            <div class="paramFil">
                <h4>Region Selectionnée</h4>
                <select class="menuDeroulantFils">
                    <option>Département</option>
                    <option>Département 1</option>
                    <option>Département 2</option>
                    <option>Département 3</option>
                </select>
            </div>
            <button>Créer</button>
        </div>
    -->
    <div class="discussion">
        {{range .Chats}}
        <div class="discussion-cree" onclick="selectChat('{{.Name}}')">
            <div class="discussion-cree-info">
                <img src="{{.PhotoURL}}" alt="user photo" class="discussion-cree-info-profil">

                <div class="discussion-cree-info-texte">
                    <p class="discussion-cree-info-titre">{{.Name}}</p>
                    <p class="discussion-cree-info-nom">{{.Creator}}</p>
                </div>
            </div>

            <p class="discussion-cree-descriptif">{{.Descri}}</p>



            <div class="discussion-cree-chat">
                {{if $.IsConnected}}
                    <div class="chat-coeur-container" data-chat="{{.Name}}">
                    {{if .UserLiked}}
                        <img src="static/img/coeur_rouge.png" alt="Liked" class="chat-coeur">
                    {{else}}
                        <img src="static/img/coeurGris.png" alt="Like" class="chat-coeur">
                    {{end}}
                    <p>{{.TotalLikes}}</p>
                    </div>
                {{end}}
                <div class="discussionFil">
                    <img src="static/img/messager.png" alt="discussion">
                    <p>{{.MessageCount}}</p>
                </div>
            </div>
        </div>
        {{else}}
        <p>Aucun chat personnalisé n'a encore été créé dans {{.Region}}. Créé en un maintenant!</p>
        {{end}}
    </div>


    </section>

    <script>
        function PopupFils() {
            const popupFils = document.getElementById("popupAjouterFil");
            const imageBtnFils = document.getElementById("btnAjouterFil");

            if (popupFils.style.display === "flex") {
                document.getElementById("popupAjouterFil").style.display = "none";
                document.getElementById("btnAjouterFil").src = "static/img/ajouter.png"
            } else {
                document.getElementById("popupAjouterFil").style.display = "flex";
                document.getElementById("btnAjouterFil").src = "static/img/moin.png"
            }
        }

        function fetchChats(region) {
    fetch(`/fetch-chats?region=${region}`)
        .then(response => response.json())
        .then(data => {
            const chatList = document.getElementById("chat-list");
            chatList.innerHTML = ""; // Clear current chats

            // Handle case when no chats are available
            if (!data.Chats || data.Chats.length === 0) {
                const noChatsMessage = document.createElement("p");
                noChatsMessage.textContent = `No chats available in ${region}. Create one below!`;
                chatList.appendChild(noChatsMessage);
                return;
            }

            // Display Principal Chat
            if (data.MainChat) {
                const principalChat = document.createElement("div");
                principalChat.className = "principal-chat";
                principalChat.innerHTML = `
                    <h3>Principal Chat</h3>
                    <p>Name: ${data.MainChat.Name}</p>
                    <p>Description: ${data.MainChat.Descri}</p>
                    <p>Messages: ${data.MainChat.MessageCount}</p>
                    <p>Total Likes: ${data.MainChat.TotalLikes}</p>
                    <img src="${data.MainChat.ImageURL}" alt="Region Image">
                `;
                chatList.appendChild(principalChat);
            }

            // Display User Chats
            const userChatsTitle = document.createElement("h3");
            userChatsTitle.textContent = "User Chats";
            chatList.appendChild(userChatsTitle);

            data.Chats.forEach(chat => {
                const listItem = document.createElement("li");
                listItem.className = "chat-item";

                listItem.innerHTML = `
                    <button>${chat.Name} (${chat.Creator})</button>
                    <p>Description: ${chat.Descri}</p>
                    <p>Messages: ${chat.MessageCount}</p>
                    <p>Total Likes: ${chat.TotalLikes}</p>
                    <img src="${chat.PhotoURL}" alt="Creator Image">
                `;

                // Event listener for chat selection
                const button = listItem.querySelector("button");
                button.addEventListener("click", () => {
                    selectChat(chat.Name); // Function for handling chat selection
                });

                chatList.appendChild(listItem);
            });
        })
        .catch(error => console.error("Error fetching chats:", error));
}


        function selectChat(chatName) {
            fetch(`/select-chat?chatname=${chatName}`)
                .then(response => {
                    if (response.ok) {
                        window.location.href = "/chat_messages"; // Reindirizza alla pagina dei messaggi
                    } else {
                        console.error("Failed to select chat:", response.statusText);
                    }
                })
                .catch(error => console.error("Error selecting chat:", error));
        }


        document.addEventListener("DOMContentLoaded", function () {
            fetchChats("{{.Region}}");
        });

        function createChat() {
            const chatTitle = document.getElementById("chatTitle").value.trim();
            const chatDescription = document.getElementById("chatDescription").value.trim(); // Fetch description
            const region = document.getElementById("regionField").value;

            if (!chatTitle || !region) {
                alert("Le titre et la région sont obligatoires !");
                return;
            }

            // Send data via POST
            fetch("/create-chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `chatname=${encodeURIComponent(chatTitle)}&description=${encodeURIComponent(chatDescription)}&region=${encodeURIComponent(region)}`
            })
                .then(response => {
                    if (response.ok) {
                        window.location.href = "/welcome"; // Redirect to welcome page
                    } else {
                        console.error("Failed to create chat:", response.statusText);
                        alert("Échec de la création du chat. Veuillez réessayer !");
                    }
                })
                .catch(error => {
                    console.error("Error creating chat:", error);
                    alert("Une erreur s'est produite lors de la création du chat.");
                });
        }


    </script>
    <script src="static/script.js"></script>
</body>

</html>